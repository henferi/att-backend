generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// üîê User & Auth
// =======================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())

  // Relasi
  tokens       Token[]
  refreshTokens RefreshToken[]
  passwordResetTokens PasswordResetToken[]
  workspaces   WorkspaceUser[]
  departments  Department[]   @relation("UserToDepartments")
  offices      Office[]       @relation("UserToOffices")
  jobLevels    JobLevel[]     @relation("UserToJobLevels")
  jobTitles    JobTitle[]     @relation("UserToJobTitles")
  employees    Employee[]

  deviceAttendances DeviceAttendance[]
  logAttendances    LogAttendance[]
}

model Token {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  type      String   @default("access")
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RefreshToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// =======================
// üß© Workspace
// =======================
model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  users       WorkspaceUser[]
  departments Department[]   @relation("WorkspaceToDepartments")
  offices     Office[]       @relation("WorkspaceToOffices")
  jobLevels   JobLevel[]     @relation("WorkspaceToJobLevels")
  jobTitles   JobTitle[]     @relation("WorkspaceToJobTitles")
  employees   Employee[]
}

model WorkspaceUser {
  id           String    @id @default(cuid())
  userId       String
  workspaceId  String
  role         String
  createdAt    DateTime  @default(now())

  user       User       @relation(fields: [userId], references: [id])
  workspace  Workspace  @relation(fields: [workspaceId], references: [id])

  @@unique([userId, workspaceId])
}

// =======================
// üë• Struktur Organisasi
// =======================
model Department {
  id           String    @id @default(cuid())
  name         String
  createdAt    DateTime  @default(now())

  userId       String
  workspaceId  String

  user       User       @relation("UserToDepartments", fields: [userId], references: [id])
  workspace  Workspace  @relation("WorkspaceToDepartments", fields: [workspaceId], references: [id])

  employees  Employee[]
}

model Office {
  id           String    @id @default(cuid())
  name         String
  location     String?
  createdAt    DateTime  @default(now())

  userId       String
  workspaceId  String

  user       User       @relation("UserToOffices", fields: [userId], references: [id])
  workspace  Workspace  @relation("WorkspaceToOffices", fields: [workspaceId], references: [id])

  employees  Employee[]
}

model JobLevel {
  id           String    @id @default(cuid())
  name         String
  createdAt    DateTime  @default(now())

  userId       String
  workspaceId  String

  user       User       @relation("UserToJobLevels", fields: [userId], references: [id])
  workspace  Workspace  @relation("WorkspaceToJobLevels", fields: [workspaceId], references: [id])

  titles     JobTitle[] @relation("LevelToTitle")
  employees  Employee[]
}

model JobTitle {
  id           String    @id @default(cuid())
  name         String
  createdAt    DateTime  @default(now())

  userId       String
  workspaceId  String
  levelId      String?

  user       User       @relation("UserToJobTitles", fields: [userId], references: [id])
  workspace  Workspace  @relation("WorkspaceToJobTitles", fields: [workspaceId], references: [id])
  level      JobLevel?  @relation("LevelToTitle", fields: [levelId], references: [id])

  employees  Employee[]
}

// =======================
// üßë‚Äçüíº Karyawan
// =======================
model Employee {
  id           String  @id @default(cuid())
  name         String
  email        String  @unique
  phone        String?
  photo        String?
  createdAt    DateTime @default(now())

  userId       String
  workspaceId  String
  officeId     String
  departmentId String
  jobTitleId   String
  jobLevelId   String

  user       User       @relation(fields: [userId], references: [id], map: "fk_employee_user")
  workspace  Workspace  @relation(fields: [workspaceId], references: [id], map: "fk_employee_workspace")
  office     Office     @relation(fields: [officeId], references: [id], map: "fk_employee_office")
  department Department @relation(fields: [departmentId], references: [id], map: "fk_employee_department")
  jobTitle   JobTitle   @relation(fields: [jobTitleId], references: [id], map: "fk_employee_job_title")
  jobLevel   JobLevel   @relation(fields: [jobLevelId], references: [id], map: "fk_employee_job_level")
}


// =======================
// üìü Mesin & Log Absensi
// =======================
model DeviceAttendance {
  id             String   @id @default(uuid())
  deviceId       String
  deviceUsername String?
  devicePassword String?
  createdAt      DateTime?
  editedAt       DateTime?
  deletedAt      DateTime?

  userId String
  user   User   @relation(fields: [userId], references: [id])

  logs   LogAttendance[]
}

model LogAttendance {
  id                 Int     @id @default(autoincrement())
  deviceAttendanceId String
  deviceId           String
  deviceTypeId       Int
  ioMode             String
  attDatetime        DateTime?
  createdAt          DateTime?
  editedAt           DateTime?
  deletedAt          DateTime?

  userId             String
  user               User             @relation(fields: [userId], references: [id])
  deviceAttendance   DeviceAttendance @relation(fields: [deviceAttendanceId], references: [id])
}
